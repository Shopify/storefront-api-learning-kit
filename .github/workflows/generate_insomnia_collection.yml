name: Generate Insomnia collection for Storefront API

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: Make output directory
        run: |
          mkdir -p collections/insomnia

      - name: Get API Version
        id: version
        run: |
          API_VERSION="$(date +'%Y-%m')"
          echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
          BRANCH_NAME="${API_VERSION}-insomnia-collection-auto-generated"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Checkout GraphQL export repo
        run: |
          git clone https://github.com/postmodem/graphql-export.git
          cd graphql-export
          yarn install
          yarn build
          echo $(pwd)
          yarn start -u https://sjp-johns-tackle.myshopify.com/api/${API_VERSION}/graphql.json -f insomnia -H  "X-Shopify-Storefront-Access-Token: 1cf96f6483755396c20f88a7ab59ccf8" "Content-Type: application/json" -r "X-Shopify-Storefront-Access-Token:" "Accepts: application/json" -q QueryRoot -m Mutation

      - name: Create and push the release branch
        run: |
          git checkout -B $BRANCH_NAME # -B will reset branch if it exists
          git push --set-upstream --force origin $BRANCH_NAME

      - name: Build new SDK version
        run: |
          echo "Generating schema for $API_VERSION"
          mv ./export.json ../collections/insomnia/collection.json
          cd ..
          git add collections/
          git commit -m "Update Insomnia collection (auto-generated)"
          git push --set-upstream --force origin $BRANCH_NAME

      - name: Create pull request
        uses: actions/github-script@0.9.0
        with:
          script: |
            const api_version = process.env.API_VERSION
            const branch_name = process.env.BRANCH_NAME
            github.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Update Schema to `" + api_version + "` Release",
              head: branch_name,
              base: 'main',
              body: "### Release notes" +
                "\n" +
                `\nThe [latest schema changes](https://shopify.dev/api/release-notes/${api_version}#graphql-storefront-api-changes).` +
                "\n" +
              })
