name: Generate Insomnia collection for Storefront API

on:
  schedule:
    # Run on midnight UTC on the first of jan/apr/jul/oct
    # API is released 1PM EDT/EST
    - cron: '59 23 1 1/3 *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.6'

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: Get API Version
        id: version
        run: |
          API_VERSION="$(./scripts/api_version.rb)"
          echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
          BRANCH_NAME="${API_VERSION}-insomnia-collection-auto-generated"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create and push the release branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -B $BRANCH_NAME # -B will reset branch if it exists
          git push --set-upstream --force origin $BRANCH_NAME

      - name: Checkout GraphQL export repo
        run: |
          git clone https://github.com/postmodem/graphql-export.git
          cd graphql-export
          yarn install
          yarn build
          echo $(pwd)
          yarn start -u https://sjp-johns-tackle.myshopify.com/api/${API_VERSION}/graphql.json -f insomnia -H  "X-Shopify-Storefront-Access-Token: 1cf96f6483755396c20f88a7ab59ccf8" "Content-Type: application/json" -r "X-Shopify-Storefront-Access-Token:" "Accepts: application/json" -q QueryRoot -m Mutation
          git checkout -B $BRANCH_NAME # -B will reset branch if it exists
          echo "Generating collection for $API_VERSION"
          mkdir -p ../insomnia
          mv ./export.json ../insomnia/collection.json
          cd ..
          git add insomnia/
          git commit -m "Update Insomnia collection (auto-generated)"
          git push --set-upstream --force origin $BRANCH_NAME

      - name: Create pull request
        uses: actions/github-script@0.9.0
        with:
          script: |
            const api_version = process.env.API_VERSION
            const branch_name = process.env.BRANCH_NAME
            github.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Update Insomnia collection to `" + api_version + "` Release",
              head: branch_name,
              base: 'main',
              body: "### Release notes" +
                "\n" +
                `\nThe [latest schema changes](https://shopify.dev/api/release-notes/${api_version}#graphql-storefront-api-changes).` +
                "\n"
              })
